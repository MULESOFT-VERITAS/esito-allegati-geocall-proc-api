<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd">

	<sub-flow name="esitoAllegatiToSapCallSub" doc:id="6c8c2254-d194-4fb9-934d-0b7d8f164b17" >
		<ee:transform doc:name="Input" doc:id="2eadd79f-b7c8-44c2-a8db-d9638854183d">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/xml
ns urn urn:sap-com:document:sap:rfc:functions
---
urn#Z_WS_GEOCALL_ESITO_ALLEGATI: {
  ALLEGATO_01: {
    TIPO_ALLEGATO: payload.tipoAllegato,
    PROGRESSIVO: vars.counter,
    NOME_FILE_ORIGINALE: payload.nomeFileOriginale,
    NOME_FILE_NORMALIZZATO: payload.nomeFileNormalizzato,
    DESCRIZIONE: payload.descrizione,
    FORMATO: payload.formato,
    DIMENSIONE: payload.dimensione,
    CONT_FILE: vars.attachmentGeoCall.contFile
  },
  EXTERNALCODE: vars.savePratica.externalCode,
  NOTIFICATIONNUMBERSAP: vars.savePratica.notificationNumberSap,
  TOTALE_ALLEGATI: vars.countAllegati,
  T_RETURN: "",
  WOCODE: vars.savePratica.wocode
  
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="START" doc:id="dc37b983-ec6d-43fe-95e8-4e4886953805" message="#[%dw 2.0&#10;output application/json skipNullOn=&quot;everywhere&quot;&#10;&#10;&#10;var logPayload =  payload update {&#10;    case Z_WS_GEOCALL_ESITO_ALLEGATI at .Z_WS_GEOCALL_ESITO_ALLEGATI -&gt;&#10;      Z_WS_GEOCALL_ESITO_ALLEGATI update {&#10;        case ALLEGATO_01 at .ALLEGATO_01 -&gt;&#10;          ALLEGATO_01 - &quot;CONT_FILE&quot;&#10;      }&#10;  } &#10;var status = &quot;ok&quot;&#10;var msg = &quot;START EsitoAllegati to SAP&quot;&#10;&#10;---&#10;CustomLogMapper::logger(&#10; {&#10;  correlationId: vars.correlationId default correlationId,&#10;  app: app,&#10;  mule: mule,&#10;  status: status,&#10;  message: msg,&#10;  (payload: write(logPayload,&quot;application/xml&quot;)) if (p('log.level') == &quot;DEBUG&quot;) ,   &#10;  env: p('mule.env')&#10; }&#10;)]" />
		<http:request method="POST" doc:name="Z_WS_GEOCALL_ESITO_ALLEGATI" doc:id="445bb6d7-b1eb-4e88-b24f-e18c53d6df96" config-ref="HTTP_Configuration_SAP" path="${sap.uri}" target="outputGetAttachmentsGeoCall">
			<non-repeatable-stream />
			<reconnect frequency="${http.frequency}" count="${http.reconnection}" />
			<http:body ><![CDATA[#[%dw 2.0
output application/xml 
ns soapenv http://schemas.xmlsoap.org/soap/envelope/
---

soapenv#Envelope @('xmlns:ser': "http://services.sol.atos.net/") :{
    soapenv#Header : {
    },
    soapenv#Body:
		payload
    
}]]]></http:body>
			<http:headers><![CDATA[#[output application/json
---
{
	"Content-Type" : "text/xml;charset=UTF-8",
	"Accept": "application/xml",
	"operation": "Z_WS_GEOCALL_ESITO_ALLEGATI"
	}]]]></http:headers>
		</http:request>
		<ee:transform doc:name="output" doc:id="296393cb-b4b0-4eaa-b1b6-f9b5843ca60d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
ns n0 urn:sap-com:document:sap:rfc:functions

var itemsRaw = payload.body.n0#Z_WS_GEOCALL_ESITO_ALLEGATIResponse.T_RETURN.item
var items = if (typeOf(itemsRaw) == "Array") itemsRaw else [itemsRaw]

var firstItem = items[0]
---
n0#Z_WS_GEOCALL_ESITO_ALLEGATIResponse: {
  T_RETURN: {
    item: firstItem
  }
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="END" doc:id="31bd5d54-5f53-4d4c-851d-320ee0aa6975" message="#[%dw 2.0&#10;output application/json skipNullOn=&quot;everywhere&quot;&#10;&#10;&#10;var logPayload = payload default &quot;&quot;&#10;var status = &quot;ok&quot;&#10;var msg = &quot;END EsitoAllegati from SAP&quot;&#10;&#10;---&#10;CustomLogMapper::logger(&#10; {&#10;  correlationId: vars.correlationId default correlationId,&#10;  app: app,&#10;  mule: mule,&#10;  status: status,&#10;  message: msg,&#10;  (payload: write(logPayload,&quot;application/xml&quot;)) if (p('log.level') == &quot;DEBUG&quot;),   &#10;  env: p('mule.env')&#10; }&#10;)]" />
	</sub-flow>
</mule>
