<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd">
	<error-handler name="Apikit_Error_Handler" doc:id="b08a01a3-6844-4ac6-8c76-f81445af7aef">
	<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="9bdff357-538b-4703-8667-f19d1992490b" when="#[(error.errorType.namespace == 'APIKIT') or (error.errorType.identifier contains 'APIKIT')]">
			<ee:transform doc:name="httpStatus" doc:id="030b4031-75f0-4fc5-9f84-9426d570922f">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus"><![CDATA[output application/json

var apikitErrorType = "$(error.errorType.namespace default 'APIKIT'):$(error.errorType.identifier default '')"
---
apikitErrorType match {
  case "APIKIT:BAD_REQUEST" -> 400
  case "APIKIT:NOT_FOUND" -> 404
  case "APIKIT:METHOD_NOT_ALLOWED" -> 405
  case "APIKIT:NOT_ACCEPTABLE" -> 406
  case "APIKIT:UNSUPPORTED_MEDIA_TYPE" -> 415
  case "APIKIT:NOT_IMPLEMENTED" -> 501
  case "APIKIT:ANY" -> 500
}]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<ee:transform doc:name="error-payload" doc:id="78eb0bd3-0914-4f03-9241-beda907ab619" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
import ErrorMapper
output application/json skipNullOn="everywhere"
---
ErrorMapper::error(
	{
		error:error, 
		errorCode: vars.httpStatus default 500,
		vars:vars,
		correlationId:correlationId, 
		app:app, 
		mule:mule,
		env: p('mule.env')
	}
)]]></ee:set-payload>
				</ee:message>
				<ee:variables />
			</ee:transform>
<logger level="ERROR" doc:name="log-error" doc:id="182c57ce-fa2e-47c6-be24-3f1004a72f49" message="#[%dw 2.0&#10;output application/json skipNullOn=&quot;everywhere&quot;&#10;&#10;&#10;var logPayload = payload.infoMessage default &quot;&quot;&#10;var status = &quot;KO&quot;&#10;var msg = &quot;An APIKIT Error Occurred&quot;&#10;&#10;---&#10;CustomLogMapper::logger(&#10;	{&#10;  		correlationId: vars.correlationId default correlationId,&#10;		app: app,&#10;		mule: mule,&#10;		status: status,&#10;		message: msg,&#10;		payload: logPayload,		 &#10;		env: p('mule.env')&#10;	}&#10;)]" />			
		</on-error-propagate>
	</error-handler>
	<error-handler name="Global_Error_Handler" doc:id="c4ec2e41-0923-49a7-bdf3-3baa0eaf4b40" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="0aad0a6c-be3c-4185-992a-6b62039c20ef" type="HTTP:NOT_FOUND" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="404" doc:name="httpStatus" doc:id="b3f690b6-0bcd-4f79-81a1-a41397981c86" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="04936323-4edf-44e1-882f-ecdf1cce012b" name="CommonErrorMsgTemplateNoWsc" />

		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="ed4a951d-2140-43a0-89d1-4b736453c968" type="HTTP:INTERNAL_SERVER_ERROR" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="7ea4ba22-f771-41df-a1b1-c7fe8aba1a86" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="2d03fac2-cc4f-4e2c-b637-74c6b0316a37" name="CommonErrorMsgTemplateNoWsc" />

		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="31c0c9ac-fd55-4012-b0f4-5d47959bfe7e" type="HTTP:TIMEOUT" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="408" doc:name="httpStatus" doc:id="886bb57f-043a-471a-86f6-77059648176a" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="7029d44b-92ff-4a76-be2a-54098d336e82" name="CommonErrorMsgTemplateNoWsc" />

		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="1e05879f-9713-4688-a399-6e7672b78963" type="MULE:EXPRESSION" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="3e89ca96-5db8-4f5d-a9e2-9c259dac4d58" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="513946a3-b22e-4705-912a-0c5c51aeefc7" name="CommonErrorMsgTemplateNoWsc" />

		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="aab574d6-a6ba-44ee-87ac-7a45030c0a96" type="HTTP:UNAUTHORIZED" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="401" doc:name="httpStatus" doc:id="eb7fed13-abe1-40dc-98e8-392f6d40e16d" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="feddd27f-07b1-46d5-9ce7-dbf50ea98207" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="ff4c302f-c1d3-4e48-abd2-ec443906ea6d" type="HTTP:BAD_REQUEST" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="400" doc:name="httpStatus" doc:id="0cba296e-2ac9-41f3-ad9e-7582a6843546" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="3e9d8f96-d6b8-4741-8d8a-bf17e222d49f" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="6c045a95-461c-47ce-ae7e-410aef4e7964" type="HTTP:FORBIDDEN" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="403" doc:name="httpStatus" doc:id="3fa97a55-5c37-46e9-84d4-376411d87f46" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="ad88d5cd-4e36-43ad-bad9-71ba0d1a310a" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		
		
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="daeba919-f109-4007-8234-6dd9b4564eed" type="ANYPOINT-MQ:CONNECTIVITY" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="21be6304-1978-49b9-bd71-24db8d0ad167" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="dddd85f0-5105-4c4a-8404-326b6760c54c" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="648079e4-8a2a-4032-b742-fa183472c72c" type="ANYPOINT-MQ:DESTINATION_NOT_FOUND" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="37525ce1-be89-4626-b52f-30cad90b78f7" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="e24c827c-2e9d-496b-9f30-eb1695dc88e8" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="a2cde466-2b07-4116-84d6-0585c8992a2f" type="ANYPOINT-MQ:ILLEGAL_BODY" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="92e58d3f-51fa-48a6-ade8-d3fab36aebee" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="9f2c1b0b-bebd-4fe1-aa1e-f30160ddc335" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="93d3d09a-d3be-43f4-b0b2-cae5eeb78878" type="ANYPOINT-MQ:PUBLISHING" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="75a7e151-a26d-43ed-9338-8b8cceef46d7" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="071e4c90-e6e5-460c-91f9-873e3d5cc627" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="ce10378a-69b4-4f5f-b3b2-119f921786ef" type="ANYPOINT-MQ:RETRY_EXHAUSTED" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="9f4320fe-b2c8-4fef-9698-8cfe02928361" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="de1ba72e-3c6f-465f-ad2f-48cd9a1d95fd" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		
		
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="370ce0d1-7110-45f9-9091-be766b6d35f0" type="WSC:BAD_REQUEST" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="400" doc:name="httpStatus" doc:id="eb922523-d172-4a53-8f78-1b5084d4ccbc" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="edc4f376-4f48-429b-b2af-47cf3c4bd597" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="c3cbe3a9-44b4-4a13-a21c-d1b56cb19742" type="WSC:BAD_RESPONSE" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="98429765-0b8a-4a24-af89-2ffa166457c3" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="8c5be966-b5e2-4fe3-b124-e8c8a7b2e472" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="61e5b85a-b130-4151-9799-faec2902ffa3" type="WSC:CANNOT_DISPATCH" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="acde4864-2b73-4431-815b-4ee02e76c326" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="5fff2821-5e93-4445-a214-e7748ddf88bf" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="f083fb74-83a9-44b5-a14c-f146df0fea2d" type="WSC:CONNECTIVITY" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="64266152-dc1a-4591-b429-7b2b844eb0f2" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="72dba954-f84a-456d-b962-b5d56c3745da" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e44958a3-3eab-4c9c-b0ea-1f669b6efc8f" type="WSC:EMPTY_RESPONSE" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="694d50a4-7d5e-42ac-b795-428663806efc" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="d5e5aa88-6e17-46f6-8c47-c1eff36fae60" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e873c231-8236-44a7-ad3d-1b15734400db" type="WSC:ENCODING" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="f8b3ea78-9dcb-454c-82c7-c93d6d1e5b07" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="ca9eed39-3f65-4dab-95d1-748b41a60b2e" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="7407ab03-87f9-4c2b-9c4b-6ccf7cce7d90" type="WSC:INVALID_WSDL" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="811c3796-2113-4ef1-bcd0-2e65ea1be327" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="24b073f7-7ecc-4e41-a281-8165d54a12bb" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="2c73f878-3aa8-4620-9aa7-d3048bd55cdf" type="WSC:RETRY_EXHAUSTED" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="ba585019-4e7c-46c5-80f0-1400f2761434" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="bf54c3bf-14d0-4fcc-9a31-f808a12eb164" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="26153571-1e7c-490b-b3bd-f0e4ebf3524f" type="WSC:SOAP_FAULT" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="0b2f2205-7ad8-4dfa-8e51-528598749390" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="c4336b5d-c5cc-4c50-8b8f-e60a4b4fd672" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="20f91cab-fa85-4f86-aca3-902445f793eb" type="WSC:TIMEOUT" when='#[isEmpty(vars."error-already-logged")]'>
			<set-variable value="500" doc:name="httpStatus" doc:id="40dc8f2f-20f5-4835-a906-2beec33a0763" variableName="httpStatus" />
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="e992611f-4cb0-48f4-a16d-58a3189f61cb" name="CommonErrorMsgTemplateWsc" />
		</on-error-propagate>
		
		
		
		
		
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="8cb96684-02da-4a70-bfd5-d2e18aceb659" type="ANY" when='#[isEmpty(vars."error-already-logged")]'>
			<flow-ref doc:name="CommonErrorMsgTemplate" doc:id="12466ac8-1a96-466f-8017-81427cab3d8c" name="CommonErrorMsgTemplateNoWsc" />
		</on-error-propagate>
		

</error-handler>
	<sub-flow name="CommonErrorMsgTemplateNoWsc" doc:id="3cc262a9-3c2a-4a8a-95c6-349e8eac881f" >
		<ee:transform doc:name="error" doc:id="a303d2c7-fdb1-4143-885a-f770aeb3d73b">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
import ErrorMapper
import mergeWith from dw::core::Objects
output application/json skipNullOn="everywhere"
---
ErrorMapper::error(
	{
		error:error, 
		errorCode: vars.httpStatus default 500,
		vars:vars,
		correlationId:correlationId, 
		app:app, 
		mule:mule,
		env: p('mule.env')
	}
)]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="error-already-logged"><![CDATA["error-already-handled"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="ERROR" doc:name="Logger error" doc:id="63ba12fe-6d0a-4135-bb49-73c9cebfb52b" message='#[import mergeWith from dw::core::Objects&#10;output json &#10;---&#10; payload  mergeWith {&#10;	("childErrors": error.childErrors)if(!isEmpty(error.childErrors)),&#10;    "falingComponent": error.failingComponent,&#10;  	 correlationId: vars.correlationId default correlationId&#10;}]' />
		<choice doc:name="Choice" doc:id="1743034a-b6d0-4f3a-aaab-d57c3bf89674" >
			<when expression="#[vars.mqSub != null]">
				<choice doc:name="Choice" doc:id="5e00f4d7-dda6-43a4-b6e8-44aab8a85a22">
			<when expression="#[vars.retryCount &lt;= 3]">
				<anypoint-mq:publish doc:name="Publish" doc:id="cbb8c1f3-b23e-4e5b-9f32-9946509b8601" config-ref="Anypoint_MQ_Config" destination="${mq.esito-allegati}">
					<reconnect frequency="${mq.frequency}" count="${mq.reconnection}" />
					<anypoint-mq:body><![CDATA[#[output application/json
---
{
	pratica: vars.savePratica,
	listaAllegati: [vars.saveCurrentLista]
}]]]></anypoint-mq:body>
					<anypoint-mq:properties><![CDATA[#[{
	corrlationId: vars.correlationId,
	retryCount: (vars.retryCount as Number) + 1
}]]]></anypoint-mq:properties>
				</anypoint-mq:publish>
			</when>
			<otherwise>
				<anypoint-mq:publish doc:name="PublishDLQ" doc:id="bbc8370b-baaa-4d04-9d9c-80def2ea918a" config-ref="Anypoint_MQ_Config" destination="${mq.esito-allegati-dlq}">
					<reconnect frequency="${mq.frequency}" count="${mq.reconnection}" />
					<anypoint-mq:body><![CDATA[#[output application/json
---
{
	pratica: vars.savePratica,
	listaAllegati: [vars.saveCurrentLista]
}]]]></anypoint-mq:body>
					<anypoint-mq:properties><![CDATA[#[{
	corrlationId: vars.correlationId,
	retryCount: vars.retryCount
}]]]></anypoint-mq:properties>
				</anypoint-mq:publish>
			</otherwise>
		</choice>
			</when>
			<otherwise >
				<logger level="ERROR" doc:name="Logger" doc:id="a6ef8406-5d7e-4c72-bf90-a04eba324939" message="Not MQ"/>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="CommonErrorMsgTemplateWsc" doc:id="1b9645cd-e422-45a4-9278-41f8ddad4453" >
		<ee:transform doc:name="error" doc:id="a4176eb2-aef5-4290-af04-c968720ef3fe" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---

{
  "correlationId": vars.correlationId default correlationId,
  "applicationName": p('app.name'),
  "applicationVersion": "4.8.1",
  "applicationEnvironment": p('mule.env'),
  "timestamp": now() as LocalDateTime,
  "infoMessage": {
    "errorCode": vars.httpStatus,
    "errorDescription": "Errore invocazione al webservice",
    "errorOn": p('app.name'),
    "errorType": error.errorType.identifier
  }
}]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="error-already-logged" ><![CDATA["error-already-handled"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="ERROR" doc:name="Logger error" doc:id="02af8d20-773a-43c4-8ab2-ff4b167ae730" message='#[import mergeWith from dw::core::Objects&#10;output json &#10;---&#10; payload  mergeWith {&#10;	("childErrors": error.childErrors)if(!isEmpty(error.childErrors)),&#10;    "falingComponent": error.failingComponent,&#10;  	 correlationId: vars.correlationId default correlationId&#10;}]' />
		<choice doc:name="Choice" doc:id="6832a8b5-91e2-4972-bc76-d65eb93d4a66" >
			<when expression="#[vars.mqSub != null]">
				<choice doc:name="Choice" doc:id="659dd40a-431c-47aa-8dc7-6a66ee3a484d">
			<when expression="#[vars.retryCount &lt;= 3]">
				<anypoint-mq:publish doc:name="Publish" doc:id="701375f9-26b1-4330-a898-24c1e54ad5c9" config-ref="Anypoint_MQ_Config" destination="${mq.esito-allegati}">
					<reconnect frequency="${mq.frequency}" count="${mq.reconnection}" />
					<anypoint-mq:body><![CDATA[#[output application/json
---
{
	pratica: vars.savePratica,
	listaAllegati: [vars.saveCurrentLista]
}]]]></anypoint-mq:body>
					<anypoint-mq:properties><![CDATA[#[{
	corrlationId: vars.correlationId,
	retryCount: (vars.retryCount as Number) + 1
}]]]></anypoint-mq:properties>
				</anypoint-mq:publish>
			</when>
			<otherwise>
				<anypoint-mq:publish doc:name="PublishDLQ" doc:id="890f93c5-e6b6-4ae1-b75b-cef45298bc83" config-ref="Anypoint_MQ_Config" destination="${mq.esito-allegati-dlq}">
					<reconnect frequency="${mq.frequency}" count="${mq.reconnection}" />
					<anypoint-mq:body><![CDATA[#[output application/json
---
{
	pratica: vars.savePratica,
	listaAllegati: [vars.saveCurrentLista]
}]]]></anypoint-mq:body>
					<anypoint-mq:properties><![CDATA[#[{
	corrlationId: vars.correlationId,
	retryCount: vars.retryCount
}]]]></anypoint-mq:properties>
				</anypoint-mq:publish>
			</otherwise>
		</choice>
			</when>
			<otherwise >
				<logger level="ERROR" doc:name="Logger" doc:id="8f3ec8ab-cb5e-4eb3-aa0f-b05663947037" message="Not MQ"/>
			</otherwise>
		</choice>
	</sub-flow>
	
</mule>
